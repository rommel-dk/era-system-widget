name: Sync system status (ClickUp â†’ data/system.json)

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: system-status-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci --omit=dev

      # Run your harvester (adjust path if needed)
      - name: Harvest ClickUp system messages
        run: node server/services/clickup-system.js
        env:
          CLICKUP_TOKEN: ${{ secrets.CLICKUP_TOKEN }}
          CLICKUP_WORKSPACE_ID: ${{ secrets.CLICKUP_WORKSPACE_ID }}
          # Optional knobs (you can delete these if you want defaults)
          CU_DOC_NAME_FILTER: "System|Status|Incidents"
          CU_FULL_RESYNC: "0"
          CU_SINCE_HOURS: "72"
          CU_CONCURRENCY: "6"

      - name: Commit & push if changed
        run: |
          git config user.name "era-bot"
          git config user.email "bot@era.dk"
