<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Service Status Widget</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
		:root {
			--bg:#fff; --border:#e2e8f0; --text:#1f2933; --muted:#6b7280;
			--ok:#16a34a; --warn:#facc15; --error:#dc2626; --accent:#2563eb;
			--radius:12px; --shadow:0 10px 25px rgba(15,23,42,.08);
			--font:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
		}

		body { margin:0; font-family:var(--font); background:transparent; color:var(--text); }

		.widget {
			max-width:480px; margin:0 auto; background:var(--bg);
			border-radius:var(--radius); border:1px solid var(--border);
			box-shadow:var(--shadow); padding:18px 20px 22px;
			box-sizing:border-box;
		}

		.header { display:flex; gap:12px; margin-bottom:8px; align-items:center; }
		.logo {
			width:40px;height:40px;border-radius:999px;background:#0f172a;
			display:flex;align-items:center;justify-content:center;
			color:#fff;font-weight:700;
		}
		h1 { font-size:16px;margin:0 }
		.subtitle { font-size:12px;color:var(--muted);margin-top:2px }

		.status-row {
			display:flex;justify-content:space-between;align-items:center;
			padding:10px 12px;margin:12px 0;
			background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;
		}
		.status-main { display:flex;gap:10px;align-items:center }
		.dot { width:12px;height:12px;border-radius:999px }
		.dot.ok{background:var(--ok);box-shadow:0 0 0 6px rgba(22,163,74,.18)}
		.dot.warn{background:var(--warn);box-shadow:0 0 0 6px rgba(250,204,21,.18)}
		.dot.error{background:var(--error);box-shadow:0 0 0 6px rgba(220,38,38,.18)}
		.tag { font-size:11px;padding:3px 8px;border-radius:999px;font-weight:500 }

		h2 { font-size:13px;margin:0 0 4px }
		.desc { font-size:12px;color:var(--muted);margin-bottom:6px }
		.last-updated { font-size:11px; color:var(--muted); margin:2px 0 10px; }

		ul { padding-left:18px;margin:0 }
		li { font-size:12px;margin-bottom:10px }
		.chip {
			display:inline-block;font-size:10px;font-weight:700;
			padding:2px 8px;border-radius:999px;margin-right:6px;
			border:1px solid transparent;
		}
		.chip.ok{background:#dcfce7;color:#166534;border-color:#bbf7d0}
		.chip.warning{background:#fef9c3;color:#854d0e;border-color:#fde68a}
		.chip.error{background:#fee2e2;color:#991b1b;border-color:#fecaca}
		small{display:block;color:var(--muted);margin-top:2px;white-space:pre-wrap}

		/* CONTACT FORM */
		.contact { border-top:1px solid #e5e7eb;margin-top:14px;padding-top:12px }
		label { font-size:11px;color:var(--muted);display:block;margin:8px 0 3px }
		input, textarea {
			width:100%;font-size:13px;padding:7px 9px;
			border-radius:8px;border:1px solid #d1d5db;
			font-family:inherit;box-sizing:border-box;
		}
		textarea{min-height:70px;resize:vertical}
		button {
			background:var(--accent);color:#fff;border:none;
			padding:7px 14px;border-radius:999px;
			font-size:13px;font-weight:500;cursor:pointer;
		}
		.form-row { display:flex;justify-content:space-between;align-items:center;margin-top:8px; gap:10px }
		.form-status { font-size:11px;color:var(--muted); text-align:right; flex:1 }
    </style>
</head>

<body>
<div class="widget">
    <div class="header">
        <div class="logo">era</div>
        <div>
            <h1>Service status</h1>
            <div class="subtitle">Live system information</div>
        </div>
    </div>

    <div class="status-row">
        <div class="status-main">
            <div class="dot ok" id="dot"></div>
            <div>
                <div id="status-title">All systems operational</div>
                <div class="subtitle" id="status-sub">No incidents reported</div>
            </div>
        </div>
        <span class="tag" id="status-tag">Operational</span>
    </div>

    <h2>System messages</h2>
    <div class="desc" id="desc"></div>
    <div class="last-updated" id="last-updated"></div>
    <ul id="list"></ul>

    <div class="contact">
        <h2>Contact us</h2>
        <div class="desc">Send us a message and our support team will get back to you.</div>

        <form id="contact-form">
            <input type="hidden" name="client_id" id="client_id" value="">
            <label>Name</label>
            <input required name="name" autocomplete="name">
            <label>Email</label>
            <input required type="email" name="email" autocomplete="email">
            <label>Message</label>
            <textarea required name="message" placeholder="Describe the issue or question"></textarea>

            <div class="form-row">
                <button type="submit">Send</button>
                <span class="form-status" id="form-status"></span>
            </div>
        </form>
    </div>
</div>

<script>
    // ===== CONFIG =====
    const STATUS_URL_REL = "./data/system.json";
    // Fallback absolute (helps when embedded in weird contexts)
    const STATUS_URL_ABS = "https://rommel-dk.github.io/era-system-widget/data/system.json";

    // Contact endpoint must be a real server (GitHub Pages is static)
    // You can override per-embed using: ?contact=https://yourdomain.com/api/widget-contact
    const CONTACT_URL_DEFAULT = "https://yourcompany.com/api/widget-contact";

    // ===== DOM =====
    const dot = document.getElementById("dot");
    const title = document.getElementById("status-title");
    const sub = document.getElementById("status-sub");
    const tag = document.getElementById("status-tag");
    const list = document.getElementById("list");
    const desc = document.getElementById("desc");
    const lastUpdatedEl = document.getElementById("last-updated");

    const form = document.getElementById("contact-form");
    const formStatus = document.getElementById("form-status");
    const clientIdEl = document.getElementById("client_id");

    const esc = s => String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;");

    function sendHeight() {
        if (window.parent !== window) {
            window.parent.postMessage(
                { type: "ERA_WIDGET_RESIZE", height: document.documentElement.scrollHeight },
                "*"
            );
        }
    }

    function normalizeHost(h) {
        const x = String(h || "").trim().toLowerCase();
        return x.startsWith("www.") ? x.slice(4) : x;
    }

    function getCurrentDomain() {
        const params = new URLSearchParams(location.search);
        const fromParam = params.get("domain");
        return normalizeHost(fromParam || location.hostname);
    }

    function getClientId() {
        const params = new URLSearchParams(location.search);
        // explicit client_id wins
        const cid = params.get("client_id");
        if (cid) return cid.trim();
        // fallback to domain (useful when embedded everywhere)
        const dom = getCurrentDomain();
        return dom || "unknown";
    }

    function getContactUrl() {
        const params = new URLSearchParams(location.search);
        return params.get("contact") || CONTACT_URL_DEFAULT;
    }

    function domainMatches(current, allowed) {
        if (!current || !allowed) return false;
        if (current === allowed) return true;
        return current.endsWith("." + allowed);
    }

    function filterMessagesByDomain(messages, currentDomain) {
        return (messages || []).filter(m => {
            const domains = Array.isArray(m.domains) ? m.domains.map(normalizeHost) : [];
            if (!domains.length) return true; // global
            if (!currentDomain) return false;
            return domains.some(d => d === "@" ? true : domainMatches(currentDomain, d));
        });
    }

    function computeOverall(messages) {
        if (messages.some(m => m.status === "error")) return "error";
        if (messages.some(m => m.status === "warning")) return "warn";
        return "ok";
    }

    function formatUpdatedAt(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        return d.toLocaleString("en-GB", {
            day: "2-digit",
            month: "short",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            timeZone: "Europe/Copenhagen"
        }) + " CET";
    }

    async function fetchJson(url) {
        const res = await fetch(url, { cache: "no-store" });
        const ct = res.headers.get("content-type") || "";
        const text = await res.text();

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        if (!ct.includes("application/json")) {
            throw new Error(`Expected JSON, got "${ct}". First bytes: ${text.slice(0, 80)}`);
        }
        return JSON.parse(text);
    }

    function render(data) {
        const currentDomain = getCurrentDomain();

        // Backwards compatible: if "domains" missing, treat as global
        const msgs = (data.messages || []).map(m => ({
            ...m,
            domains: Array.isArray(m.domains) ? m.domains : []
        }));

        const visible = filterMessagesByDomain(msgs, currentDomain);
        const overall = computeOverall(visible);

        dot.className = "dot " + (overall === "error" ? "error" : overall === "warn" ? "warn" : "ok");
        tag.style.background = "";
        tag.style.color = "";

        if (overall === "error") {
            title.textContent = "Service disruption";
            sub.textContent = "Active incident";
            tag.textContent = "Incident";
            tag.style.background="#fee2e2"; tag.style.color="#991b1b";
            desc.textContent = "We’re actively working on incidents.";
        } else if (overall === "warn") {
            title.textContent = "Degraded performance";
            sub.textContent = "Some systems affected";
            tag.textContent = "Degraded";
            tag.style.background="#fef9c3"; tag.style.color="#854d0e";
            desc.textContent = "Some services are currently impacted.";
        } else {
            title.textContent = "All systems operational";
            sub.textContent = "No incidents reported";
            tag.textContent = "Operational";
            tag.style.background="#dcfce7"; tag.style.color="#166534";
            desc.textContent = "Everything looks good.";
        }

        lastUpdatedEl.textContent = data.updatedAt ? ("Last updated: " + formatUpdatedAt(data.updatedAt)) : "";

        list.innerHTML = "";
        visible.forEach(m => {
            const li = document.createElement("li");
            const lvl = (m.status === "warning" ? "warning" : m.status === "error" ? "error" : "ok");
            li.innerHTML =
                `<span class="chip ${lvl}">${lvl.toUpperCase()}</span>` +
                `<strong>${esc(m.name)}</strong>` +
                `<small>${esc(m.message)}</small>`;
            list.appendChild(li);
        });

        sendHeight();
    }

    async function loadStatus() {
        try {
            const data = await fetchJson(STATUS_URL_REL);
            render(data);
        } catch (e1) {
            try {
                const data = await fetchJson(STATUS_URL_ABS);
                render(data);
            } catch (e2) {
                desc.textContent = "Status unavailable right now.";
                lastUpdatedEl.textContent = "";
                sendHeight();
            }
        }
    }

    // ===== Contact form wiring =====
    clientIdEl.value = getClientId();

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const endpoint = getContactUrl();
        formStatus.textContent = "Sending…";
        formStatus.style.color = "";

        try {
            const res = await fetch(endpoint, {
                method: "POST",
                body: new FormData(form)
            });

            if (!res.ok) throw new Error("Request failed");

            formStatus.textContent = "Message sent.";
            formStatus.style.color = "#16a34a";
            form.reset();
            clientIdEl.value = getClientId();
        } catch (err) {
            formStatus.textContent = "Something went wrong. Please try again.";
            formStatus.style.color = "#dc2626";
        } finally {
            sendHeight();
        }
    });

    // ===== Init =====
    window.addEventListener("load", sendHeight);
    window.addEventListener("resize", sendHeight);
    setTimeout(sendHeight, 250);

    loadStatus();
</script>
</body>
</html>
