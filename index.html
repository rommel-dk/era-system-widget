<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Service Status Widget</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
		:root {
			--bg:#fff; --border:#e2e8f0; --text:#1f2933; --muted:#6b7280;
			--ok:#16a34a; --warn:#facc15; --error:#dc2626; --accent:#2563eb;
			--radius:12px; --shadow:0 10px 25px rgba(15,23,42,.08);
			--font:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
		}

		body {
			margin:0;
			font-family:var(--font);
			background:transparent;
			color:var(--text);
		}

		.widget {
			max-width:480px;
			margin:0 auto;
			background:var(--bg);
			border-radius:var(--radius);
			border:1px solid var(--border);
			box-shadow:var(--shadow);
			padding:18px 20px 22px;
			box-sizing:border-box;
		}

		.header {
			display:flex;
			gap:12px;
			margin-bottom:8px;
			align-items:center;
		}

		.logo {
			width:40px;
			height:40px;
			border-radius:999px;
			background:#0f172a;
			display:flex;
			align-items:center;
			justify-content:center;
			color:#fff;
			font-weight:700;
		}

		h1 { font-size:16px; margin:0 }
		.subtitle { font-size:12px; color:var(--muted); margin-top:2px }

		.status-row {
			display:flex;
			justify-content:space-between;
			align-items:center;
			padding:10px 12px;
			margin:12px 0;
			background:#f9fafb;
			border:1px solid #e5e7eb;
			border-radius:10px;
		}

		.status-main { display:flex; gap:10px; align-items:center }

		.dot {
			width:12px;
			height:12px;
			border-radius:999px;
		}

		.dot.ok {
			background:var(--ok);
			box-shadow:0 0 0 6px rgba(22,163,74,.18);
		}
		.dot.warn {
			background:var(--warn);
			box-shadow:0 0 0 6px rgba(250,204,21,.18);
		}
		.dot.error {
			background:var(--error);
			box-shadow:0 0 0 6px rgba(220,38,38,.18);
		}

		.tag {
			font-size:11px;
			padding:3px 8px;
			border-radius:999px;
			font-weight:500;
		}

		h2 { font-size:13px; margin:0 0 4px }
		.desc { font-size:12px; color:var(--muted); margin-bottom:6px }
		.last-updated { font-size:11px; color:var(--muted); margin-bottom:10px }

		ul { padding-left:18px; margin:0 }
		li { font-size:12px; margin-bottom:10px }

		.chip {
			display:inline-block;
			font-size:10px;
			font-weight:700;
			padding:2px 8px;
			border-radius:999px;
			margin-right:6px;
		}
		.chip.ok { background:#dcfce7; color:#166534 }
		.chip.warning { background:#fef9c3; color:#854d0e }
		.chip.error { background:#fee2e2; color:#991b1b }

		small {
			display:block;
			color:var(--muted);
			margin-top:2px;
			white-space:pre-wrap;
		}
    </style>
</head>

<body>
<div class="widget">

    <div class="header">
        <div class="logo">era</div>
        <div>
            <h1>Service status</h1>
            <div class="subtitle">Live system information</div>
        </div>
    </div>

    <div class="status-row">
        <div class="status-main">
            <div class="dot ok" id="dot"></div>
            <div>
                <div id="status-title">All systems operational</div>
                <div class="subtitle" id="status-sub">No incidents reported</div>
            </div>
        </div>
        <span class="tag" id="status-tag">Operational</span>
    </div>

    <h2>System messages</h2>
    <div class="desc" id="desc"></div>
    <div class="last-updated" id="last-updated"></div>
    <ul id="list"></ul>

</div>

<script>
    const STATUS_URL = "./data/system.json";

    const dot = document.getElementById("dot");
    const title = document.getElementById("status-title");
    const sub = document.getElementById("status-sub");
    const tag = document.getElementById("status-tag");
    const desc = document.getElementById("desc");
    const list = document.getElementById("list");
    const lastUpdated = document.getElementById("last-updated");

    const esc = s => String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;");

    function normalizeHost(h) {
        const x = String(h || "").toLowerCase().trim();
        return x.startsWith("www.") ? x.slice(4) : x;
    }

    function getCurrentDomain() {
        const params = new URLSearchParams(location.search);
        return normalizeHost(params.get("domain") || location.hostname);
    }

    function domainMatches(current, allowed) {
        return current === allowed || current.endsWith("." + allowed);
    }

    function filterByDomain(messages, currentDomain) {
        return messages.filter(m => {
            const domains = Array.isArray(m.domains) ? m.domains.map(normalizeHost) : [];
            if (!domains.length) return true; // global
            return domains.some(d => domainMatches(currentDomain, d));
        });
    }

    function computeOverall(msgs) {
        if (msgs.some(m => m.status === "error")) return "error";
        if (msgs.some(m => m.status === "warning")) return "warn";
        return "ok";
    }

    function formatDate(iso) {
        if (!iso) return "";
        return new Date(iso).toLocaleString("en-GB", {
            day:"2-digit", month:"short", year:"numeric",
            hour:"2-digit", minute:"2-digit",
            timeZone:"Europe/Copenhagen"
        }) + " CET";
    }

    async function load() {
        try {
            const res = await fetch(STATUS_URL, { cache:"no-store" });
            const data = await res.json();

            const domain = getCurrentDomain();
            const visible = filterByDomain(data.messages || [], domain);
            const overall = computeOverall(visible);

            dot.className = "dot " + (overall === "error" ? "error" : overall === "warn" ? "warn" : "ok");

            if (overall === "error") {
                title.textContent = "Service disruption";
                sub.textContent = "Active incident";
                tag.textContent = "Incident";
                tag.style.background="#fee2e2"; tag.style.color="#991b1b";
                desc.textContent = "Weâ€™re actively working on incidents.";
            } else if (overall === "warn") {
                title.textContent = "Degraded performance";
                sub.textContent = "Some systems affected";
                tag.textContent = "Degraded";
                tag.style.background="#fef9c3"; tag.style.color="#854d0e";
                desc.textContent = "Some services are currently impacted.";
            } else {
                title.textContent = "All systems operational";
                sub.textContent = "No incidents reported";
                tag.textContent = "Operational";
                tag.style.background="#dcfce7"; tag.style.color="#166534";
                desc.textContent = "Everything looks good.";
            }

            lastUpdated.textContent = data.updatedAt
                ? "Last updated: " + formatDate(data.updatedAt)
                : "";

            list.innerHTML = "";
            visible.forEach(m => {
                const li = document.createElement("li");
                li.innerHTML =
                    `<span class="chip ${m.status}">${m.status.toUpperCase()}</span>` +
                    `<strong>${esc(m.name)}</strong>` +
                    `<small>${esc(m.message)}</small>`;
                list.appendChild(li);
            });

        } catch {
            desc.textContent = "Status unavailable right now.";
        }
    }

    load();
</script>

</body>
</html>
